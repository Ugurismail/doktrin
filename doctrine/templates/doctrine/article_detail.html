{% extends 'base.html' %}

{% block title %}{{ article.get_article_type_display }} {{ article.article_number }} - Bizlik{% endblock %}

{% block content %}

<div class="container proposal-container" style="max-width: 1400px; padding-left: 40px; padding-right: 40px;">
    <!-- Back Button -->
    <a href="{% url 'doctrine:doctrine_list' %}" class="proposal-back-link">
        ‚Üê Bizlike Geri D√∂n
    </a>

    <!-- Single Column Layout -->
    <div style="margin-top: 12px;">
        <!-- Article Card -->
        <div class="card">
            <div class="proposal-header">
                <div>
                    <h1 class="proposal-title">
                        {{ article.get_article_type_display }} {{ article.article_number }}
                    </h1>
                    <div class="proposal-meta">
                        <span class="proposal-meta-item">
                            {{ article.created_by.username }}
                        </span>
                        <span class="proposal-meta-separator">‚Ä¢</span>
                        <span class="proposal-meta-item">
                            {{ article.created_date|date:"d M Y" }}
                        </span>
                    </div>
                </div>

                {% if article.article_type == 'FOUNDATION_LAW' %}
                    <span class="proposal-badge-active" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); color: #D97706;">
                        ƒ∞lke
                    </span>
                {% else %}
                    <span class="proposal-badge-passed">
                        Program
                    </span>
                {% endif %}
            </div>

            <div class="proposal-content-section">
                <h3 class="proposal-content-title">ƒ∞√ßerik</h3>

                <!-- Tags Display -->
                {% if article.tags.all %}
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 24px;">
                    {% for tag in article.tags.all %}
                    <a href="{% url 'doctrine:doctrine_list' %}?tag={{ tag.slug }}"
                       style="padding: 6px 16px; border-radius: 16px; font-size: 13px; text-decoration: none; background: {{ tag.color }}; color: white; font-weight: 500;"
                       title="{{ tag.description }}">
                        üè∑Ô∏è {{ tag.name }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}

                <p class="proposal-content-text" style="text-align: justify; font-size: 18px; line-height: 1.8;">
                    {{ article.content }}
                </p>
            </div>

            <!-- Collapsible Justification Section -->
            {% if justification_text or can_edit_justification %}
            <div style="margin-top: 32px; padding-top: 32px; border-top: 2px solid var(--border);">
                <button
                    onclick="toggleJustification()"
                    class="btn btn-secondary"
                    style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; font-size: 16px; font-weight: 600;"
                    id="justificationToggleBtn"
                >
                    <span>üìÑ Gerek√ße</span>
                    <span id="justificationIcon" style="font-size: 20px; transition: transform 0.3s;">‚ñº</span>
                </button>

                <div id="justificationContent" style="display: none; margin-top: 24px; padding: 24px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
                    {% if can_edit_justification %}
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                        <button
                            class="btn btn-primary"
                            style="padding: 8px 16px; font-size: 14px;"
                            onclick="toggleEditJustification()"
                            id="editJustificationBtn"
                        >
                            D√ºzenle
                        </button>
                    </div>
                    {% endif %}

                    <!-- View Mode -->
                    <div id="justificationView">
                        {% if justification_text %}
                            <p style="font-size: 17px; line-height: 1.9; color: var(--text); font-style: italic; white-space: pre-wrap; text-align: justify;">{{ justification_text }}</p>
                        {% else %}
                            <div style="text-align: center; padding: 40px 20px; color: var(--text-light); font-size: 14px;">
                                {% if article.article_type == 'FOUNDATION_LAW' %}
                                    {% if can_edit_justification %}
                                        <p>Gerek√ße eklemek i√ßin "D√ºzenle" butonuna tƒ±klayƒ±n.</p>
                                    {% else %}
                                        <p>Hen√ºz gerek√ße eklenmemi≈ü.</p>
                                    {% endif %}
                                {% else %}
                                    <p>Bu madde i√ßin gerek√ße bulunmamaktadƒ±r.</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Edit Mode -->
                    {% if can_edit_justification %}
                    <div id="justificationEdit" style="display: none;">
                        <form method="post">
                            {% csrf_token %}
                            <textarea
                                name="justification"
                                placeholder="Gerek√ßenizi buraya yazƒ±n..."
                                style="width: 100%; min-height: 300px; padding: 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; font-family: inherit; line-height: 1.6; background: var(--bg); color: var(--text); resize: vertical;"
                            >{{ justification_text }}</textarea>
                            <div style="display: flex; gap: 8px; margin-top: 12px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    Kaydet
                                </button>
                                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="toggleEditJustification()">
                                    ƒ∞ptal
                                </button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Version History Section -->
        {% if versions %}
        <div class="card" style="margin-top: 32px;">
            <button
                onclick="toggleVersionHistory()"
                class="btn btn-secondary"
                style="width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; font-size: 16px; font-weight: 600;"
                id="versionToggleBtn"
            >
                <span>üìö Versiyon Ge√ßmi≈üi ({{ versions|length }})</span>
                <span id="versionIcon" style="font-size: 20px; transition: transform 0.3s;">‚ñº</span>
            </button>

            <div id="versionHistoryContent" style="display: none; margin-top: 24px;">
                <!-- Version Search -->
                <form method="get" style="margin-bottom: 20px;">
                    <div style="position: relative;">
                        <input
                            type="text"
                            name="version_search"
                            value="{{ version_search }}"
                            placeholder="üîç Versiyon ge√ßmi≈üinde ara..."
                            style="width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); font-size: 14px;"
                        >
                        {% if version_search %}
                        <a href="{% url 'doctrine:article_detail' article.id %}" style="position: absolute; right: 12px; top: 12px; color: var(--text-light); text-decoration: none; font-size: 18px;">√ó</a>
                        {% endif %}
                    </div>
                </form>

                {% if version_search %}
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px; border-left: 4px solid var(--primary);">
                    <span style="font-size: 14px;">
                        <strong>Arama:</strong> "{{ version_search }}"
                        <span style="color: var(--text-light);">({{ versions|length }} sonu√ß bulundu)</span>
                    </span>
                </div>
                {% endif %}

                <div style="display: flex; flex-direction: column; gap: 16px;">
                    {% for version in versions %}
                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <span style="font-size: 14px; font-weight: 700; color: var(--accent);">v{{ version.version_number }}</span>
                                <span style="margin: 0 8px; color: var(--text-secondary);">‚Ä¢</span>
                                <span style="font-size: 14px; color: var(--text-secondary);">{{ version.created_at|date:"d M Y, H:i" }}</span>
                            </div>
                            {% if version.changed_by_proposal %}
                            <a href="{% url 'doctrine:proposal_detail' version.changed_by_proposal.id %}" style="font-size: 13px; color: var(--accent); text-decoration: none;">
                                √ñneriye Git ‚Üí
                            </a>
                            {% endif %}
                        </div>
                        <p style="font-size: 15px; line-height: 1.7; color: var(--text); margin: 0; white-space: pre-wrap;">{{ version.content }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Comments Section -->
        <div class="card" style="margin-top: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                <h2 style="font-size: 28px; font-weight: 700; margin: 0;">Tartƒ±≈üma</h2>
                <span style="font-size: 16px; color: var(--text-light);">{{ discussions.paginator.count }} yorum</span>
            </div>

            <!-- Comment Form -->
            <div style="margin-bottom: 40px;">
                <form method="post">
                    {% csrf_token %}
                    <textarea
                        name="comment"
                        placeholder="G√∂r√º≈ülerinizi payla≈üƒ±n..."
                        required
                        style="width: 100%; min-height: 140px; padding: 20px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; font-family: inherit; background: var(--bg-secondary); color: var(--text); resize: vertical; transition: all 0.3s;"
                        onfocus="this.style.borderColor='var(--primary)'"
                        onblur="this.style.borderColor='var(--border)'"
                    ></textarea>
                    <button type="submit" class="btn btn-primary" style="margin-top: 16px; padding: 14px 28px; font-size: 16px;">
                        Yorum G√∂nder
                    </button>
                </form>
            </div>

            <!-- Comments List -->
            {% if discussions %}
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    {% for discussion in discussions %}
                    <div style="padding: 24px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
                        <!-- Yorum metni √∂nce, b√ºy√ºk -->
                        <p style="font-size: 18px; line-height: 1.8; color: var(--text); margin: 0 0 16px 0; font-weight: 400;">{{ discussion.comment_text }}</p>

                        <!-- Meta bilgiler k√º√ß√ºk, altta -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div>
                                <span style="font-weight: 600; color: var(--text-light); font-size: 13px;">{{ discussion.user.username }}</span>
                                <span style="margin-left: 8px; font-size: 12px; color: var(--text-light);">{{ discussion.created_at|date:"d M Y, H:i" }}</span>
                            </div>
                        </div>

                        {% include "doctrine/_discussion_vote_buttons.html" %}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 80px 20px; color: var(--text-light);">
                    <p style="font-size: 18px;">Hen√ºz yorum yok. ƒ∞lk yorumu siz yapƒ±n!</p>
                </div>
            {% endif %}

            <!-- Pagination -->
            {% if discussions.has_other_pages %}
            <div class="pagination" style="margin-top: 48px;">
                {% if discussions.has_previous %}
                    <a href="?page=1">ƒ∞lk</a>
                    <a href="?page={{ discussions.previous_page_number }}">‚Üê</a>
                {% else %}
                    <span class="disabled">ƒ∞lk</span>
                    <span class="disabled">‚Üê</span>
                {% endif %}

                <span class="page-info">
                    Sayfa {{ discussions.number }} / {{ discussions.paginator.num_pages }}
                </span>

                {% if discussions.has_next %}
                    <a href="?page={{ discussions.next_page_number }}">‚Üí</a>
                    <a href="?page={{ discussions.paginator.num_pages }}">Son</a>
                {% else %}
                    <span class="disabled">‚Üí</span>
                    <span class="disabled">Son</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleJustification() {
    const content = document.getElementById('justificationContent');
    const icon = document.getElementById('justificationIcon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        icon.textContent = '‚ñ≤';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
        icon.textContent = '‚ñº';
    }
}

function toggleEditJustification() {
    const viewMode = document.getElementById('justificationView');
    const editMode = document.getElementById('justificationEdit');
    const editBtn = document.getElementById('editJustificationBtn');

    if (viewMode.style.display === 'none') {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
        if (editBtn) editBtn.textContent = 'D√ºzenle';
    } else {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
        if (editBtn) editBtn.textContent = 'ƒ∞ptal';
    }
}

function toggleVersionHistory() {
    const content = document.getElementById('versionHistoryContent');
    const icon = document.getElementById('versionIcon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        icon.textContent = '‚ñ≤';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
        icon.textContent = '‚ñº';
    }
}
</script>

{% endblock %}
