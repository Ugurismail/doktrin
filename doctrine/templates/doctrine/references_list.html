{% extends 'base.html' %}
{% load static %}

{% block title %}Kaynaklar - Bizlik{% endblock %}

{% block content %}

<div class="container">
    <div class="page-header">
        <h1 class="page-title">📚 Kaynaklar</h1>
        <p class="page-subtitle">
            Bizlik platformunda kullanılan tüm akademik kaynaklar.
            Kaynakların üzerine gelerek hangi madde ve ilkelerde kullanıldığını görebilirsiniz.
        </p>
    </div>

    <div class="filters-bar">
        <div class="search-box">
            <input type="text" id="searchReferences" placeholder="🔍 Yazar, başlık veya yıla göre ara..." class="search-input">
        </div>
        <div class="filter-buttons">
            <button onclick="filterByType('all')" class="filter-btn active" data-type="all">
                Tümü ({{ references.paginator.count }})
            </button>
            <button onclick="filterByType('BOOK')" class="filter-btn" data-type="BOOK">
                Kitap
            </button>
            <button onclick="filterByType('ARTICLE')" class="filter-btn" data-type="ARTICLE">
                Makale
            </button>
            <button onclick="filterByType('JOURNAL')" class="filter-btn" data-type="JOURNAL">
                Dergi
            </button>
            <button onclick="filterByType('WEBSITE')" class="filter-btn" data-type="WEBSITE">
                Web Sitesi
            </button>
            <button onclick="filterByType('OTHER')" class="filter-btn" data-type="OTHER">
                Diğer
            </button>
        </div>
    </div>

    <div class="references-list" id="referencesGrid">
        {% for ref in references %}
        <div class="reference-row"
             data-type="{{ ref.reference_type }}"
             data-author="{{ ref.author|lower }}"
             data-title="{{ ref.title|lower }}"
             data-year="{{ ref.year }}">

            <div class="ref-row-main">
                <div class="ref-row-left">
                    <div class="ref-citation">
                        <span class="ref-author">{{ ref.author }}</span>
                        <span class="ref-year">({{ ref.year }})</span>
                        <span class="ref-title">{{ ref.title }}</span>
                        {% if ref.publisher %}<span class="ref-publisher">{{ ref.publisher }}</span>{% endif %}
                        {% if ref.city %}<span class="ref-city">{{ ref.city }}</span>{% endif %}
                    </div>
                </div>

                <div class="ref-row-right">
                    <button class="ref-usage-badge" onclick="showUsageModal({{ ref.id }})" title="Kullanım yerlerini gör">
                        📖 {{ ref.usage_count }}
                    </button>

                    {% if ref.url %}
                    <a href="{{ ref.url }}" target="_blank" class="ref-link-btn" title="Kaynağa git">🔗</a>
                    {% endif %}

                    {% if ref.created_by == request.user %}
                    <button class="ref-edit-btn" onclick="openEditReferenceModal({{ ref.id }})" title="Düzenle">✏️</button>
                    {% endif %}

                    {% if ref.is_verified %}
                    <span class="ref-verified" title="Doğrulanmış">✓</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <div class="empty-icon">📚</div>
            <h3>Henüz kaynak eklenmemiş</h3>
            <p>İlk kaynağı ekleyen siz olun!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if references.has_other_pages %}
    <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: var(--space-xl); padding: var(--space-lg);">
        {% if references.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-secondary); color: var(--text); text-decoration: none; transition: all 0.2s;">İlk</a>
            <a href="?page={{ references.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-secondary); color: var(--text); text-decoration: none; transition: all 0.2s;">←</a>
        {% else %}
            <span style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text-secondary); opacity: 0.5;">İlk</span>
            <span style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text-secondary); opacity: 0.5;">←</span>
        {% endif %}

        <span style="padding: 8px 16px; font-weight: 600; color: var(--text);">
            Sayfa {{ references.number }} / {{ references.paginator.num_pages }}
        </span>

        {% if references.has_next %}
            <a href="?page={{ references.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-secondary); color: var(--text); text-decoration: none; transition: all 0.2s;">→</a>
            <a href="?page={{ references.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-secondary); color: var(--text); text-decoration: none; transition: all 0.2s;">Son</a>
        {% else %}
            <span style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text-secondary); opacity: 0.5;">→</span>
            <span style="padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg); color: var(--text-secondary); opacity: 0.5;">Son</span>
        {% endif %}
    </div>
    {% endif %}

    <!-- Usage Modal -->
    <div id="usageModal" class="usage-modal" onclick="if(event.target === this) closeUsageModal()">
        <div class="usage-modal-content">
            <div class="usage-modal-header">
                <h2>📖 Kaynak Kullanım Yerleri</h2>
                <button class="usage-modal-close" onclick="closeUsageModal()">&times;</button>
            </div>
            <div class="usage-modal-body" id="usageModalBody">
                <div class="usage-loading">Yükleniyor...</div>
            </div>
        </div>
    </div>

    <!-- Citation Format Modal -->
    <div id="citationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Atıf Bilgisi</h2>
                <button type="button" class="modal-close" onclick="closeCitationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="citationContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCitationModal()">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
// Arama fonksiyonu
document.getElementById('searchReferences').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.reference-row');

    rows.forEach(row => {
        const author = row.dataset.author;
        const title = row.dataset.title;
        const year = row.dataset.year;

        if (author.includes(searchTerm) ||
            title.includes(searchTerm) ||
            year.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Tip filtreleme
function filterByType(type) {
    const rows = document.querySelectorAll('.reference-row');
    const buttons = document.querySelectorAll('.filter-btn');

    // Button aktiflik durumunu güncelle
    buttons.forEach(btn => {
        if (btn.dataset.type === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });

    // Satırları filtrele
    rows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Usage Modal Functions
function showUsageModal(refId) {
    const modal = document.getElementById('usageModal');
    const body = document.getElementById('usageModalBody');

    modal.style.display = 'flex';
    body.innerHTML = '<div class="usage-loading"><div class="spinner"></div><p>Yükleniyor...</p></div>';

    // Load usage data
    fetch('/doctrine/api/references/' + refId + '/usage/')
        .then(response => response.json())
        .then(data => {
            if (data.usage_count === 0) {
                body.innerHTML = `
                    <div class="usage-empty">
                        <div class="usage-empty-icon">📭</div>
                        <p>Bu kaynak henüz hiçbir maddede kullanılmamış</p>
                    </div>
                `;
                return;
            }

            let html = '';

            if (data.articles && data.articles.length > 0) {
                html += '<div class="usage-section">';
                html += '<h3 class="usage-section-title">📜 İlkeler ve Program</h3>';
                html += '<div class="usage-list">';
                data.articles.forEach(article => {
                    html += `
                        <a href="/doctrine/article/${article.id}/" class="usage-item">
                            <span class="usage-item-icon">🏛️</span>
                            <span class="usage-item-text">${article.article_type} ${article.article_number}</span>
                            <span class="usage-item-arrow">→</span>
                        </a>
                    `;
                });
                html += '</div></div>';
            }

            if (data.proposals && data.proposals.length > 0) {
                html += '<div class="usage-section">';
                html += '<h3 class="usage-section-title">💡 Öneriler</h3>';
                html += '<div class="usage-list">';
                data.proposals.forEach(proposal => {
                    html += `
                        <a href="/doctrine/proposal/${proposal.id}/" class="usage-item">
                            <span class="usage-item-icon">📝</span>
                            <span class="usage-item-text">Öneri #${proposal.id} - ${proposal.proposal_type}</span>
                            <span class="usage-item-arrow">→</span>
                        </a>
                    `;
                });
                html += '</div></div>';
            }

            body.innerHTML = html || '<div class="usage-empty"><p>Kullanım bilgisi bulunamadı</p></div>';
        })
        .catch(error => {
            body.innerHTML = `
                <div class="usage-error">
                    <div class="usage-error-icon">⚠️</div>
                    <p>Veriler yüklenirken bir hata oluştu</p>
                </div>
            `;
            console.error('Error loading usage data:', error);
        });
}

function closeUsageModal() {
    const modal = document.getElementById('usageModal');
    modal.style.display = 'none';
}

// Citation modal
function showCitationModal(refId) {
    // TODO: Citation formatlarını göster
}

function closeCitationModal() {
    document.getElementById('citationModal').classList.remove('active');
}
</script>

<style>
.references-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-xl);
}

.reference-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: var(--space-md);
    transition: all 0.2s;
    position: relative;
}

.reference-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--accent);
    transform: translateY(-2px);
}

.reference-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.reference-type-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-book { background: #e3f2fd; color: #1976d2; }
.badge-article { background: #f3e5f5; color: #7b1fa2; }
.badge-journal { background: #e8f5e9; color: #388e3c; }
.badge-website { background: #fff3e0; color: #f57c00; }
.badge-other { background: #eceff1; color: #546e7a; }

.verified-badge {
    background: var(--success-color);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

.reference-author {
    font-weight: 700;
    font-size: 1rem;
    color: var(--text);
    margin-bottom: var(--space-xs);
}

.reference-title {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
    line-height: 1.4;
}

.reference-meta {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
}

.reference-url a {
    color: var(--accent);
    text-decoration: none;
    font-size: 0.85rem;
}

.reference-url a:hover {
    text-decoration: underline;
}

.reference-card-footer {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
}

.reference-usage {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    cursor: help;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.2s;
    color: var(--text-secondary);
}

.reference-usage:hover {
    background: var(--bg);
}

.reference-creator {
    color: var(--text-secondary);
    font-size: 0.75rem;
}

/* Popover */
.usage-popover {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: var(--space-md);
    min-width: 300px;
    max-width: 400px;
    z-index: 1000;
}

.usage-popover::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 20px;
    border: 8px solid transparent;
    border-top-color: var(--bg);
}

.usage-details h4 {
    margin: 0 0 var(--space-sm) 0;
    font-size: 0.9rem;
    color: var(--text);
}

.usage-details ul {
    margin: 0;
    padding-left: 20px;
    list-style: none;
}

.usage-details li {
    margin-bottom: var(--space-xs);
}

.usage-details a {
    color: var(--accent);
    text-decoration: none;
}

.usage-details a:hover {
    text-decoration: underline;
}

.filters-bar {
    display: flex;
    gap: var(--space-lg);
    align-items: center;
    margin-top: var(--space-lg);
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 300px;
}

.search-input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    background: var(--bg);
    color: var(--text);
}

.filter-buttons {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
}

.filter-btn {
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border);
    background: var(--bg-secondary);
    color: var(--text);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.filter-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
}

.filter-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: var(--space-xxl);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: var(--space-md);
}

@media (max-width: 768px) {
    .references-grid {
        grid-template-columns: 1fr;
    }

    .filters-bar {
        flex-direction: column;
        align-items: stretch;
    }

    .search-box {
        width: 100%;
    }
}

.btn-edit-reference {
    padding: 0.4rem 0.8rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-edit-reference:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

.reference-actions {
    display: flex;
    gap: 0.5rem;
}
</style>

<!-- Düzenleme Modalı -->
<div id="editReferenceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Kaynağı Düzenle</h2>
            <button type="button" class="modal-close" onclick="closeEditReferenceModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editReferenceForm">
                <input type="hidden" id="edit_ref_id">

                <div class="form-group">
                    <label for="edit_ref_type">Kaynak Türü</label>
                    <select id="edit_ref_type" required>
                        <option value="BOOK">Kitap</option>
                        <option value="ARTICLE">Makale</option>
                        <option value="JOURNAL">Dergi</option>
                        <option value="WEBSITE">Web Sitesi</option>
                        <option value="REPORT">Rapor</option>
                        <option value="THESIS">Tez</option>
                        <option value="OTHER">Diğer</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Yazar(lar) *</label>
                    <div id="edit_authorsList" class="dynamic-list"></div>
                    <div class="author-input-row">
                        <input type="text" id="edit_author_lastname" placeholder="Soyadı" class="author-input">
                        <input type="text" id="edit_author_firstname" placeholder="Adı" class="author-input">
                        <button type="button" class="btn-add-item" onclick="addEditAuthor()">+ Ekle</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit_ref_title">Eser Başlığı *</label>
                    <input type="text" id="edit_ref_title" required>
                </div>

                <div class="form-group">
                    <label for="edit_ref_year">Yayın Yılı *</label>
                    <input type="number" id="edit_ref_year" min="1000" max="2100" required>
                </div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label for="edit_ref_publisher">Yayınevi</label>
                        <input type="text" id="edit_ref_publisher">
                    </div>
                    <div class="form-group">
                        <label for="edit_ref_city">Yayın Yeri</label>
                        <input type="text" id="edit_ref_city">
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit_ref_url">Online Link (URL)</label>
                    <input type="url" id="edit_ref_url">
                </div>

                <div class="form-group">
                    <label for="edit_ref_notes">Künyenin Kalanı</label>
                    <textarea id="edit_ref_notes" rows="3" placeholder="Künyeyle ilgili diğer gerekli bilgileri giriniz (çevirmen, editör, baskı, sayfa sayısı vb.)"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditReferenceModal()">İptal</button>
            <button type="button" class="btn btn-primary" onclick="updateReference()">Güncelle</button>
        </div>
    </div>
</div>

<script>
let editAuthorsList = [];

function openEditReferenceModal(refId) {
    // Kaynağı API'den çek
    fetch(`/doctrine/api/references/${refId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ref = data.reference;

                // Form alanlarını doldur
                document.getElementById('edit_ref_id').value = ref.id;
                document.getElementById('edit_ref_type').value = ref.reference_type;
                document.getElementById('edit_ref_title').value = ref.title;
                document.getElementById('edit_ref_year').value = ref.year;
                document.getElementById('edit_ref_publisher').value = ref.publisher || '';
                document.getElementById('edit_ref_city').value = ref.city || '';
                document.getElementById('edit_ref_url').value = ref.url || '';
                document.getElementById('edit_ref_notes').value = ref.notes || '';

                // Yazarları parse et ve listeye ekle
                editAuthorsList = [];
                if (ref.author) {
                    // " & " ile ayrılmış yazarları parse et
                    const authors = ref.author.split(' & ');
                    editAuthorsList = authors.map(a => a.trim());
                }
                updateEditAuthorsList();

                // Modalı aç
                document.getElementById('editReferenceModal').classList.add('active');
            }
        })
        .catch(error => {
            console.error('Kaynak yüklenirken hata:', error);
            alert('Kaynak yüklenemedi!');
        });
}

function closeEditReferenceModal() {
    document.getElementById('editReferenceModal').classList.remove('active');
    document.getElementById('editReferenceForm').reset();
    editAuthorsList = [];
    updateEditAuthorsList();
}

function addEditAuthor() {
    const lastnameInput = document.getElementById('edit_author_lastname');
    const firstnameInput = document.getElementById('edit_author_firstname');

    const lastname = lastnameInput.value.trim();
    const firstname = firstnameInput.value.trim();

    if (!lastname || !firstname) {
        alert('Lütfen hem soyadı hem adı girin');
        return;
    }

    const fullName = `${lastname}, ${firstname}`;

    if (editAuthorsList.includes(fullName)) {
        alert('Bu yazar zaten eklenmiş');
        return;
    }

    editAuthorsList.push(fullName);
    updateEditAuthorsList();

    lastnameInput.value = '';
    firstnameInput.value = '';
    lastnameInput.focus();
}

function removeEditAuthor(index) {
    editAuthorsList.splice(index, 1);
    updateEditAuthorsList();
}

function updateEditAuthorsList() {
    const container = document.getElementById('edit_authorsList');
    if (!container) return;

    if (editAuthorsList.length === 0) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = editAuthorsList.map((author, index) => `
        <div class="dynamic-list-item">
            <span>${author}</span>
            <button type="button" class="remove-btn" onclick="removeEditAuthor(${index})" title="Kaldır">×</button>
        </div>
    `).join('');
}

function updateReference() {
    const refId = document.getElementById('edit_ref_id').value;

    if (editAuthorsList.length === 0) {
        alert('Lütfen en az bir yazar ekleyin');
        return;
    }

    const title = document.getElementById('edit_ref_title').value.trim();
    const year = document.getElementById('edit_ref_year').value;

    if (!title || !year) {
        alert('Lütfen gerekli alanları doldurun (Başlık, Yıl)');
        return;
    }

    const author = editAuthorsList.join(' & ');

    const referenceData = {
        reference_type: document.getElementById('edit_ref_type').value,
        author: author,
        title: title,
        year: parseInt(year),
        publisher: document.getElementById('edit_ref_publisher').value.trim(),
        city: document.getElementById('edit_ref_city').value.trim(),
        url: document.getElementById('edit_ref_url').value.trim(),
        notes: document.getElementById('edit_ref_notes').value.trim(),
    };

    fetch(`/doctrine/api/references/${refId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(referenceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Kaynak başarıyla güncellendi! Sayfa yeniden yükleniyor...');
            location.reload();
        } else {
            alert('Hata: ' + (data.error || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('Kaynak güncellenirken hata:', error);
        alert('Kaynak güncellenirken hata oluştu!');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
