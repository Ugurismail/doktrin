{% extends 'base.html' %}

{% block title %}Ã–neri OluÅŸtur - Doktrin{% endblock %}

{% block content %}

<div class="container" style="max-width: 900px; padding-top: var(--spacing-xl);">
    <div style="margin-bottom: var(--spacing-lg);">
        <a href="{% url 'doctrine:doctrine_list' %}" style="color: var(--primary); text-decoration: none; font-weight: 500;">
            â† Doktrini Geri DÃ¶n
        </a>
    </div>

    <div class="card">
        <h1 style="font-size: 36px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: var(--spacing-md);">
            Yeni Ã–neri OluÅŸtur
        </h1>

        <div style="padding: var(--spacing-lg); background: var(--pastel-peach); border-radius: 12px; margin-bottom: var(--spacing-xl);">
            <p style="margin: 0; line-height: 1.8;">
                <strong>Yetki Seviyeniz:</strong>
                {% if user_level == 'SQUAD' %}TakÄ±m
                {% elif user_level == 'UNION' %}Birlik
                {% elif user_level == 'PROVINCE_ORG' %}Ä°l Ã–rgÃ¼tÃ¼
                {% endif %}
                <br>
                Bu seviyede doktrini deÄŸiÅŸtirme Ã¶nerisi sunabilirsiniz. <strong>ÅÄ°MDÄ°LÄ°K TEST Ä°Ã‡Ä°N:</strong> Ã–neri 10 dakika boyunca oylamaya aÃ§Ä±k kalacaktÄ±r.
            </p>
        </div>

        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label for="proposal_type">Ã–neri TÃ¼rÃ¼</label>
                <select id="proposal_type" name="proposal_type" required onchange="toggleArticleSelect()">
                    <option value="">SeÃ§in</option>
                    <option value="ADD">Yeni Madde Ekle</option>
                    <option value="MODIFY">Mevcut Maddeyi DeÄŸiÅŸtir</option>
                    <option value="REMOVE">Madde KaldÄ±r</option>
                </select>
            </div>

            <div class="form-group" id="article_select_div" style="display: none;">
                <label for="related_article" id="article_select_label">DeÄŸiÅŸtirilecek Madde</label>
                <select id="related_article" name="related_article">
                    <option value="">Madde SeÃ§in</option>
                    {% for article in all_articles %}
                    <option value="{{ article.id }}">
                        {{ article.get_article_type_display }} {{ article.article_number }} -
                        {{ article.content|truncatewords:10 }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" id="tags_select_div" style="display: none;">
                <label for="tags">Etiketler (Ä°steÄŸe BaÄŸlÄ±)</label>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                    {% for tag in all_tags %}
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 14px; background: var(--bg); border-radius: 20px; border: 2px solid transparent; transition: all 0.2s;">
                        <input type="checkbox" name="tags" value="{{ tag.id }}" style="cursor: pointer;">
                        <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: {{ tag.color }};"></span>
                        <span style="font-size: 14px;">{{ tag.name }}</span>
                    </label>
                    {% endfor %}
                </div>
                <small style="color: var(--text-secondary); display: block; margin-top: var(--spacing-sm);">
                    Yeni maddeniz iÃ§in uygun etiketleri seÃ§in. Bu, maddenin kategorize edilmesine yardÄ±mcÄ± olur.
                </small>
            </div>

            <div class="form-group">
                <label for="proposed_content">Ã–nerilen Ä°Ã§erik</label>
                <textarea id="proposed_content" name="proposed_content" rows="10" required
                    placeholder="Yeni madde iÃ§eriÄŸini veya deÄŸiÅŸiklik Ã¶nerinizi buraya yazÄ±n..."
                    style="line-height: 1.8;"></textarea>
                <small style="color: var(--text-secondary); display: block; margin-top: var(--spacing-sm);">
                    Net ve aÃ§Ä±k bir ÅŸekilde yazÄ±n. <strong>TEST:</strong> Bu Ã¶neri 10 dakika boyunca oylamaya aÃ§Ä±k kalacak.
                </small>
            </div>

            <div class="form-group">
                <label for="justification">GerekÃ§e</label>
                <textarea id="justification" name="justification" rows="6" required
                    placeholder="Ã–nerinizin gerekÃ§esini aÃ§Ä±klayÄ±n..."
                    style="line-height: 1.8;"></textarea>
                <small style="color: var(--text-secondary); display: block; margin-top: var(--spacing-sm);">
                    Bu deÄŸiÅŸikliÄŸi neden Ã¶nerdiÄŸinizi aÃ§Ä±klayÄ±n. GerekÃ§e, Ã¶neri kabul edilirse maddeyle birlikte kaydedilecektir.
                </small>
            </div>

            <div style="display: flex; gap: 12px; margin-top: var(--spacing-lg);">
                <button type="button" onclick="saveDraft()" class="btn btn-secondary" style="flex: 1;">
                    ğŸ’¾ Taslak Olarak Kaydet
                </button>
                <button type="submit" class="btn btn-primary" style="flex: 2;">
                    Ã–neri OluÅŸtur ve Oylamaya AÃ§
                </button>
            </div>
        </form>

        <div id="draft-message" style="display: none; margin-top: 16px; padding: 12px; background: var(--pastel-mint); border-radius: 8px; text-align: center; font-weight: 500;"></div>
    </div>
</div>

<script>
let currentDraftId = null;

function saveDraft() {
    const proposalType = document.getElementById('proposal_type').value;
    const relatedArticle = document.getElementById('related_article').value;
    const proposedContent = document.getElementById('proposed_content').value;
    const justification = document.getElementById('justification').value;

    // Etiketleri topla
    const tagCheckboxes = document.querySelectorAll('input[name="tags"]:checked');
    const tags = Array.from(tagCheckboxes).map(cb => cb.value).join(',');

    if (!proposalType) {
        alert('LÃ¼tfen Ã¶neri tÃ¼rÃ¼ seÃ§in');
        return;
    }

    const draftData = {
        draft_id: currentDraftId,
        proposal_type: proposalType === 'ADD' ? 'NEW_ARTICLE' :
                      proposalType === 'MODIFY' ? 'AMEND_ARTICLE' :
                      proposalType === 'REMOVE' ? 'REPEAL_ARTICLE' : proposalType,
        related_article_id: relatedArticle || null,
        proposed_content: proposedContent,
        justification: justification,
        proposed_tags: tags,
        draft_title: proposalType === 'ADD' ? 'Yeni Madde TaslaÄŸÄ±' :
                    proposalType === 'MODIFY' ? 'DeÄŸiÅŸiklik TaslaÄŸÄ±' :
                    'KaldÄ±rma TaslaÄŸÄ±'
    };

    fetch('{% url "doctrine:save_proposal_draft" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(draftData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentDraftId = data.draft_id;
            const messageDiv = document.getElementById('draft-message');
            messageDiv.textContent = 'âœ“ ' + data.message;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        } else {
            alert('Taslak kaydedilemedi: ' + data.error);
        }
    })
    .catch(error => {
        alert('Hata: ' + error);
    });
}
</script>

{% endblock %}
