{% extends 'base.html' %}
{% load static %}

{% block title %}Öneri Oluştur - Bizlik{% endblock %}

{% block content %}

<div class="container form-container-lg">
    <div class="back-link-container">
        <a href="{% url 'doctrine:doctrine_list' %}" class="back-link">
            ← Bizliki Geri Dön
        </a>
    </div>

    <div class="card">
        <h1 class="page-title">
            Yeni Öneri Oluştur
        </h1>

        <div class="info-box">
            <p class="info-box-text">
                <strong>Yetki Seviyeniz:</strong>
                {% if user_level == 'SQUAD' %}Takım
                {% elif user_level == 'UNION' %}Birlik
                {% elif user_level == 'PROVINCE_ORG' %}İl Örgütü
                {% endif %}
                <br>
                Bu seviyede doktrini değiştirme önerisi sunabilirsiniz. Öneriniz 14 gün boyunca oylamaya açık kalacaktır.
            </p>
        </div>

        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label for="proposal_type">Öneri Türü</label>
                <select id="proposal_type" name="proposal_type" required onchange="toggleArticleSelect()">
                    <option value="">Seçin</option>
                    <option value="ADD">Yeni Madde Ekle</option>
                    <option value="MODIFY">Mevcut Maddeyi Değiştir</option>
                    <option value="REMOVE">Madde Kaldır</option>
                </select>
            </div>

            <div class="form-group hidden" id="article_type_select_div">
                <label for="proposed_article_type">Madde Türü</label>
                <select id="proposed_article_type" name="proposed_article_type" required>
                    <option value="NORMAL_LAW">📜 Program Maddesi</option>
                    {% if user_level == 'FOUNDER' or user_level == 'UNION' %}
                    <option value="FOUNDATION_LAW">🏛️ İlke (Sadece Kurucu ve Birlik)</option>
                    {% endif %}
                </select>
                <small class="form-hint">
                    İlkeler %85 oy ile kabul/reddedilir. Program maddeleri çoğunluk ile kabul edilir.
                </small>
            </div>

            <div class="form-group hidden" id="article_select_div">
                <label for="related_article" id="article_select_label">Değiştirilecek Madde</label>
                <select id="related_article" name="related_article">
                    <option value="">Madde Seçin</option>
                    {% for article in all_articles %}
                    <option value="{{ article.id }}">
                        {{ article.get_article_type_display }} {{ article.article_number }} -
                        {{ article.content|truncatewords:10 }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group hidden" id="tags_select_div">
                <label for="tags">Etiketler (İsteğe Bağlı)</label>
                <div class="tags-checkbox-container">
                    {% for tag in all_tags %}
                    <label class="tag-checkbox-label">
                        <input type="checkbox" name="tags" value="{{ tag.id }}" class="tag-checkbox">
                        <span class="tag-color-dot" style="background: {{ tag.color }};"></span>
                        <span class="tag-checkbox-text">{{ tag.name }}</span>
                    </label>
                    {% endfor %}
                </div>
                <small class="form-hint">
                    Yeni maddeniz için uygun etiketleri seçin. Bu, maddenin kategorize edilmesine yardımcı olur.
                </small>
            </div>

            <div class="form-group">
                <label for="proposed_content">Önerilen İçerik</label>
                <textarea id="proposed_content" name="proposed_content" rows="10" required
                    placeholder="Yeni madde içeriğini veya değişiklik önerinizi buraya yazın..."
                    class="textarea-content"></textarea>
                <small class="form-hint">
                    Net ve açık bir şekilde yazın. Öneriniz 14 gün boyunca oylamaya açık kalacaktır.
                </small>
            </div>

            <div class="form-group">
                <label for="justification">Gerekçe</label>
                <textarea id="justification" name="justification" rows="6" required
                    placeholder="Önerinizin gerekçesini açıklayın..."
                    class="textarea-content"></textarea>
                <small class="form-hint">
                    Bu değişikliği neden önerdiğinizi açıklayın. Gerekçe, öneri kabul edilirse maddeyle birlikte kaydedilecektir.
                </small>
                <div class="reference-toolbar">
                    <button type="button" onclick="openReferenceModal()" class="btn btn-secondary btn-sm">
                        📚 Yeni Kaynak Ekle
                    </button>
                    <button type="button" onclick="showAllReferences()" class="btn btn-secondary btn-sm">
                        📖 Kaynaklar
                    </button>
                </div>
            </div>

            <!-- Seçili Kaynaklar Listesi -->
            <div id="selected-references-container" class="selected-references hidden">
                <h4>Seçili Kaynaklar</h4>
                <div id="selected-references-list"></div>
            </div>

            <input type="hidden" id="selected_references" name="selected_references" value="">

            <div class="form-actions">
                <button type="button" onclick="saveDraft()" class="btn btn-secondary flex-1">
                    💾 Taslak Olarak Kaydet
                </button>
                <button type="submit" class="btn btn-primary flex-2">
                    Öneri Oluştur ve Oylamaya Aç
                </button>
            </div>
        </form>

        <div id="draft-message" class="draft-message hidden"></div>
    </div>
</div>

<script>
let currentDraftId = null;

// Form submit edilirken kaynakları güncelle
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="post"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Kaynakları hidden input'a kaydet
            if (typeof updateHiddenInput === 'function') {
                updateHiddenInput();
            }
            console.log('Form submit - selected_references:', document.getElementById('selected_references').value);
        });
    }

    // Taslak verileri varsa formu doldur
    {% if draft %}
    console.log('Taslak yükleniyor...');

    // Öneri türünü seç
    const proposalTypeSelect = document.getElementById('proposal_type');
    if (proposalTypeSelect) {
        {% if draft.proposal_type == 'NEW_ARTICLE' %}
        proposalTypeSelect.value = 'ADD';
        {% elif draft.proposal_type == 'AMEND_ARTICLE' %}
        proposalTypeSelect.value = 'MODIFY';
        {% elif draft.proposal_type == 'REPEAL_ARTICLE' %}
        proposalTypeSelect.value = 'REMOVE';
        {% endif %}

        // toggleArticleSelect fonksiyonunu çağır
        toggleArticleSelect();
    }

    // İlgili madde seç
    {% if draft.related_article %}
    const relatedArticleSelect = document.getElementById('related_article');
    if (relatedArticleSelect) {
        relatedArticleSelect.value = '{{ draft.related_article.id }}';
    }
    {% endif %}

    // Önerilen içerik
    {% if draft.proposed_content %}
    const proposedContent = document.getElementById('proposed_content');
    if (proposedContent) {
        proposedContent.value = "{{ draft.proposed_content|escapejs }}";
    }
    {% endif %}

    // Gerekçe
    {% if draft.justification %}
    const justification = document.getElementById('justification');
    if (justification) {
        justification.value = "{{ draft.justification|escapejs }}";
    }
    {% endif %}

    // Etiketler (proposed_tags varsa)
    {% if draft.proposed_tags %}
    const tagIds = '{{ draft.proposed_tags }}'.split(',');
    tagIds.forEach(tagId => {
        const checkbox = document.querySelector(`input[name="tags"][value="${tagId.trim()}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    {% endif %}

    console.log('Taslak yüklendi!');
    {% endif %}
});

function toggleArticleSelect() {
    const proposalType = document.getElementById('proposal_type').value;
    const articleDiv = document.getElementById('article_select_div');
    const articleTypeDiv = document.getElementById('article_type_select_div');
    const tagsDiv = document.getElementById('tags_select_div');
    const articleLabel = document.getElementById('article_select_label');

    if (proposalType === 'MODIFY') {
        articleDiv.classList.remove('hidden');
        articleTypeDiv.classList.add('hidden');
        articleLabel.textContent = 'Değiştirilecek Madde';
        tagsDiv.classList.add('hidden');
    } else if (proposalType === 'REMOVE') {
        articleDiv.classList.remove('hidden');
        articleTypeDiv.classList.add('hidden');
        articleLabel.textContent = 'Kaldırılacak Madde';
        tagsDiv.classList.add('hidden');
    } else if (proposalType === 'ADD') {
        articleDiv.classList.add('hidden');
        articleTypeDiv.classList.remove('hidden');
        tagsDiv.classList.remove('hidden');
    } else {
        articleDiv.classList.add('hidden');
        articleTypeDiv.classList.add('hidden');
        tagsDiv.classList.add('hidden');
    }
}

function saveDraft() {
    const proposalType = document.getElementById('proposal_type').value;
    const relatedArticle = document.getElementById('related_article').value;
    const proposedContent = document.getElementById('proposed_content').value;
    const justification = document.getElementById('justification').value;

    // Etiketleri topla
    const tagCheckboxes = document.querySelectorAll('input[name="tags"]:checked');
    const tags = Array.from(tagCheckboxes).map(cb => cb.value).join(',');

    if (!proposalType) {
        alert('Lütfen öneri türü seçin');
        return;
    }

    const draftData = {
        draft_id: currentDraftId,
        proposal_type: proposalType === 'ADD' ? 'NEW_ARTICLE' :
                      proposalType === 'MODIFY' ? 'AMEND_ARTICLE' :
                      proposalType === 'REMOVE' ? 'REPEAL_ARTICLE' : proposalType,
        related_article_id: relatedArticle || null,
        proposed_content: proposedContent,
        justification: justification,
        proposed_tags: tags,
        draft_title: proposalType === 'ADD' ? 'Yeni Madde Taslağı' :
                    proposalType === 'MODIFY' ? 'Değişiklik Taslağı' :
                    'Kaldırma Taslağı'
    };

    fetch('{% url "doctrine:save_proposal_draft" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(draftData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentDraftId = data.draft_id;
            const messageDiv = document.getElementById('draft-message');
            messageDiv.textContent = '✓ ' + data.message;
            messageDiv.classList.remove('hidden');
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        } else {
            alert('Taslak kaydedilemedi: ' + data.error);
        }
    })
    .catch(error => {
        alert('Hata: ' + error);
    });
}
</script>

<!-- Kaynakça Modal -->
<div id="referenceModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Yeni Kaynak Oluştur</h2>
            <button type="button" class="modal-close" onclick="closeReferenceModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Yeni Kaynak Formu -->
            <div id="newReferenceTab">
                <form id="newReferenceForm">
                    <div class="form-group">
                        <label for="ref_type">Kaynak Türü</label>
                        <select id="ref_type" required>
                            <option value="BOOK">Kitap</option>
                            <option value="ARTICLE">Makale</option>
                            <option value="JOURNAL">Dergi</option>
                            <option value="WEBSITE">Web Sitesi</option>
                            <option value="REPORT">Rapor</option>
                            <option value="THESIS">Tez</option>
                            <option value="OTHER">Diğer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Yazar(lar) *</label>
                        <div id="authorsList" class="dynamic-list"></div>
                        <div class="author-input-row">
                            <input type="text" id="author_lastname" placeholder="Soyadı" class="author-input">
                            <input type="text" id="author_firstname" placeholder="Adı" class="author-input">
                            <button type="button" class="btn-add-item" onclick="addAuthor()">+ Ekle</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ref_title">Eser Başlığı *</label>
                        <input type="text" id="ref_title" placeholder="Örn: Praktik Aklın Eleştirisi" required>
                    </div>
                    <div class="form-group">
                        <label for="ref_year">Yayın Yılı *</label>
                        <input type="number" id="ref_year" min="1000" max="2100" required>
                        <small class="form-hint">Sayfa numarası atıf eklerken sorulacak</small>
                    </div>
                    <div class="form-row-2">
                        <div class="form-group">
                            <label for="ref_publisher">Yayınevi</label>
                            <input type="text" id="ref_publisher" placeholder="Örn: Türkiye İş Bankası Kültür Yayınları">
                        </div>
                        <div class="form-group">
                            <label for="ref_city">Yayın Yeri</label>
                            <input type="text" id="ref_city" placeholder="Örn: İstanbul">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="ref_url">Online Link (URL)</label>
                        <input type="url" id="ref_url" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label for="ref_notes">Künyenin Kalanı</label>
                        <textarea id="ref_notes" rows="3" placeholder="Künyeyle ilgili diğer gerekli bilgileri giriniz (çevirmen, editör, baskı, sayfa sayısı vb.)"></textarea>
                    </div>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeReferenceModal()">İptal</button>
            <button type="button" class="btn btn-primary" onclick="saveNewReference()" id="saveRefBtn">Kaydet ve Ekle</button>
        </div>
    </div>
</div>

<!-- Kaynaklar Modal (Global) -->
<div id="allReferencesModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>📖 Tüm Kaynaklar</h2>
            <button type="button" class="modal-close" onclick="closeAllReferencesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <input type="text" id="searchAllReference" placeholder="🔍 Kaynaklar search..." onkeyup="searchAllReferences()">
            </div>
            <div id="allReferenceList" class="reference-list">
                <p class="text-muted">Kaynaklar yükleniyor...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAllReferencesModal()">Kapat</button>
        </div>
    </div>
</div>

{% endblock %}
